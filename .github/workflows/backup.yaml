name: Supabase Structure Export

on:
  push:
    branches: [main] # Good to run this only on main
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force export execution'
        required: true
        default: true
        type: boolean

jobs:
  export_project_structure:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # ***IMPORTANT***
      # Use the "Session Pooler" (Port 5432) connection string here
      # It must be IPv4 compatible
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      
      # Use the same logic as before to enable/disable
      EXPORT_ENABLED: ${{ (github.event_name == 'workflow_dispatch' && inputs.force_run) || vars.EXPORT_ENABLED == 'true' }}

    steps:
      - name: Check if exports are enabled
        run: |
          echo "Trigger event: ${{ github.event_name }}"
          echo "Export Enabled Status: $EXPORT_ENABLED"
          
          if [ "$EXPORT_ENABLED" != "true" ]; then
            echo "Exports are disabled. Exiting cleanly."
            exit 0
          fi

      - name: Checkout repository
        if: env.EXPORT_ENABLED == 'true'
        uses: actions/checkout@v3

      - name: Setup Supabase CLI
        if: env.EXPORT_ENABLED == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create export folder
        if: env.EXPORT_ENABLED == 'true'
        run: mkdir -p supabase/template

      - name: Export roles
        if: env.EXPORT_ENABLED == 'true'
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f supabase/template/roles.sql --role-only

      - name: Export structure (Schema-Only)
        if: env.EXPORT_ENABLED == 'true'
        # This is the key change: --schema-only exports the blueprint *without* data
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f supabase/template/structure.sql --schema-only

      - name: Commit project structure
        if: env.EXPORT_ENABLED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Export Supabase project structure"
          # Commit to the 'supabase/template' directory
          file_pattern: "supabase/template/*.sql"
          repository: .
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
