name: Supabase Structure Export

on:
  push:
    branches: [main] # Good to run this only on main
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force export execution'
        required: true
        default: true
        type: boolean

jobs:
  export_project_structure:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # ***IMPORTANT***
      # Use the "Session Pooler" (Port 5432) connection string here
      # It must be IPv4 compatible
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      
      # Use the same logic as before to enable/disable
      EXPORT_ENABLED: ${{ (github.event_name == 'workflow_dispatch' && inputs.force_run) || vars.EXPORT_ENABLED == 'true' }}

    steps:
      - name: Check if exports are enabled
        run: |
          echo "Trigger event: ${{ github.event_name }}"
          echo "Export Enabled Status: $EXPORT_ENABLED"
          
          if [ "$EXPORT_ENABLED" != "true" ]; then
            echo "Exports are disabled. Exiting cleanly."
            exit 0
          fi

      - name: Checkout repository
        if: env.EXPORT_ENABLED == 'true'
        uses: actions/checkout@v3

      - name: Setup Supabase CLI
        if: env.EXPORT_ENABLED == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create export folder
        if: env.EXPORT_ENABLED == 'true'
        run: mkdir -p supabase/template

      - name: Export roles
        if: env.EXPORT_ENABLED == 'true'
        # This is correct, --role-only is a valid Supabase CLI flag
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f supabase/template/roles.sql --role-only

      - name: Install pg_dump client (Version 17)
        if: env.EXPORT_ENABLED == 'true'
        run: |
          sudo apt-get update
          # Install prerequisites to add a new repository
          sudo apt-get install -y lsb-release wget ca-certificates
          # Create the file repository configuration:
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          # Import the repository signing key:
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          # Update the package lists:
          sudo apt-get update
          # Install the specific client version that matches your server:
          echo "Installing postgresql-client-17..."
          sudo apt-get install -y postgresql-client-17
          
      - name: Export structure (Schema-Only)
        if: env.EXPORT_ENABLED == 'true'
        # We must use pg_dump directly, as Supabase CLI wrapper has no --schema-only flag
        # We add --no-owner and --no-privileges to make the template reusable
        run: |
          echo "Exporting schema-only from database..."
          # The binary might be version-suffixed, so we check /usr/lib/postgresql/17/bin/pg_dump
          # but typically it's added to the path. We'll rely on the default path first.
          pg_dump --schema-only --quote-all-identifiers --no-owner --no-privileges -d "$SUPABASE_DB_URL" > supabase/template/structure.sql
          echo "Structure export complete."

      - name: Commit project structure
        if: env.EXPORT_ENABLED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Export Supabase project structure"
          # Commit to the 'supabase/template' directory
          file_pattern: "supabase/template/*.sql"
          repository: .
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
